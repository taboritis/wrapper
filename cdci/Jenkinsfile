properties([
    parameters([
        string(defaultValue: 'develop', name: 'branch')
    ])
])

node {
    stage('Prepare VCS') {
        checkout scm
        echo params.branch
        git branch: "${params.branch}", url: '~/Projects/wrapper'
    }

    stage('Composer') {
        sh '''
            /opt/homebrew/bin/php /opt/homebrew/bin/composer install
        '''
    }

    stage('Tests') {
        try {
            sh '''
                /opt/homebrew/bin/php ./vendor/bin/phpcs --report-full --report-junit=codesniffer-results.xml
                /opt/homebrew/bin/php ./vendor/bin/phpunit --log-junit phpunit-results.xml
            '''
        } catch (err) {
            currentBuild.result = 'FAILURE'
            echo "Caught: ${err}"
        } finally {
            junit '**/*-results.xml'
        }
    }

    stage('Report') {
        if (currentBuild.result == 'FAILURE') {
            sh "cdci/notification.fail.applescript $params.branch"
        } else {
            sh "cdci/notification.success.applescript $params.branch"
        }
    }
}